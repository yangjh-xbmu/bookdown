\documentclass[]{ctexbook}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{xltxtra,xunicode}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[a4paper,tmargin=2.5cm,bmargin=2.5cm,lmargin=3.5cm,rmargin=2.5cm]{geometry}
\usepackage[unicode=true]{hyperref}
\PassOptionsToPackage{usenames,dvipsnames}{color} % color is loaded by hyperref
\hypersetup{
            pdftitle={使用 BookDown 制作在线电子书},
            pdfauthor={杨志宏},
            colorlinks=true,
            linkcolor=Maroon,
            citecolor=Blue,
            urlcolor=Blue,
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{natbib}
\bibliographystyle{GBT7714-2005}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs}
% Fix footnotes in tables (requires footnote package)
\IfFileExists{footnote.sty}{\usepackage{footnote}\makesavenoteenv{long table}}{}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

% set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother

\usepackage{booktabs}
\usepackage{longtable}

\usepackage{framed,color}
\definecolor{shadecolor}{RGB}{248,248,248}

\renewcommand{\textfraction}{0.05}
\renewcommand{\topfraction}{0.8}
\renewcommand{\bottomfraction}{0.8}
\renewcommand{\floatpagefraction}{0.75}

\let\oldhref\href
\renewcommand{\href}[2]{#2\footnote{\url{#1}}}

\makeatletter
\newenvironment{kframe}{%
\medskip{}
\setlength{\fboxsep}{.8em}
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\makeatletter
\@ifundefined{Shaded}{
}{\renewenvironment{Shaded}{\begin{kframe}}{\end{kframe}}}
\@ifpackageloaded{fancyvrb}{%
  % https://github.com/CTeX-org/ctex-kit/issues/331
  \RecustomVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\},formatcom=\xeCJKVerbAddon}%
}{}
\makeatother

\usepackage{makeidx}
\makeindex

\urlstyle{tt}

\usepackage{amsthm}
\makeatletter
\def\thm@space@setup{%
  \thm@preskip=8pt plus 2pt minus 4pt
  \thm@postskip=\thm@preskip
}
\makeatother

\frontmatter

\title{使用 BookDown 制作在线电子书}
\author{杨志宏}
\date{2019-12-01}

\let\BeginKnitrBlock\begin \let\EndKnitrBlock\end
\begin{document}
\maketitle


\thispagestyle{empty}

\begin{center}
献给……

呃，爱谁谁吧
\end{center}

\setlength{\abovedisplayskip}{-5pt}
\setlength{\abovedisplayshortskip}{-5pt}

{
\setcounter{tocdepth}{2}
\tableofcontents
}
\listoftables
\listoffigures
\hypertarget{ux524dux8a00}{%
\chapter*{前言}\label{ux524dux8a00}}


在这本小书中，我将介绍 bookdown 的用法，并记录在使用过程中遇到的各种问题和解决方案，尽量节约后来的同好上手的时间。

以下是我的 R 进程信息：

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{sessionInfo}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 3.6.1 (2019-07-05)
## Platform: x86_64-apple-darwin15.6.0 (64-bit)
## Running under: macOS Catalina 10.15
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets 
## [6] methods   base     
## 
## loaded via a namespace (and not attached):
##  [1] compiler_3.6.1  magrittr_1.5    bookdown_0.16  
##  [4] tools_3.6.1     htmltools_0.4.0 yaml_2.2.0     
##  [7] Rcpp_1.0.3      stringi_1.4.3   rmarkdown_1.18 
## [10] knitr_1.26      stringr_1.4.0   xfun_0.11      
## [13] digest_0.6.23   rlang_0.4.2     evaluate_0.14
\end{verbatim}

\BeginKnitrBlock{flushright}
杨志宏\\
于 世界之最温暖处
\EndKnitrBlock{flushright}

\mainmatter

\hypertarget{intro}{%
\chapter{Bookdown 介绍及安装}\label{intro}}

\href{https://bookdown.org/}{Bookdown} 是一个面向科研人员的文档写作、转换、发布工具，基于 R markdown、git、gitbook、pandoc、tex等开源工具，尤其适合于爱折腾的同学。使用 bookdown 写作的在线开源书籍有：

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \href{https://bookdown.org/yihui/bookdown/}{bookdown: Authoring Books and Technical Documents with R Markdown}
\item
  \href{http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/index.html}{R 语言教程}
\end{enumerate}

\hypertarget{ux4e3aux4ec0ux4e48ux7528-bookdown}{%
\section{为什么用 bookdown}\label{ux4e3aux4ec0ux4e48ux7528-bookdown}}

相对于 Word、Tex、Gitbook、Vuepress 等工具而言，bookdown 具有如下优势：

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  编译速度快。
\item
  完美支持数学公式的显示。
\item
  内置对 R markdown 的支持，能够运行R代码，并直接将运行结果显示在文档中。
\item
  对学术写作支持更好，如参考文献、交叉引用等等。
\item
  开源，且由科研人员群体开发和维护，了解科研人员需求。
\end{enumerate}

但bookdown也存在学习成本较高的问题，估计大多数科研人员不会投入时间去了解。我碰巧有tex、gitbook的使用经验，所以在用bookdown时能够较快地掌握，但即便如此，我也花费了近2天时间，才算基本掌握。

\hypertarget{ux4f7fux7528-bookdown-ux524dux7684ux51c6ux5907ux5de5ux4f5c}{%
\section{使用 bookdown 前的准备工作}\label{ux4f7fux7528-bookdown-ux524dux7684ux51c6ux5907ux5de5ux4f5c}}

\hypertarget{ux5b89ux88c5-r}{%
\subsection{安装 R}\label{ux5b89ux88c5-r}}

到\href{https://www.r-project.org/}{R的官方网站}，下载适合系统的最新包，尤其是 Mac 系统，还需要安装官方网站提到的 XQuartz 。

\hypertarget{ux5b89ux88c5-rstudio}{%
\subsection{安装 Rstudio}\label{ux5b89ux88c5-rstudio}}

到官网下载 \href{https://rstudio.com/}{R studio}，安装到合适路径，路径名不要使用中文。

另外，RStudio 自带 Pandoc 相关工具，无需单独安装。

RStudio 的使用可参考如下文档：\url{https://resources.rstudio.com/rstudio-developed/rstudio-ide}。

\hypertarget{ux5b89ux88c5-bookdown}{%
\subsection{安装 bookdown}\label{ux5b89ux88c5-bookdown}}

启动 RStudio，设置到最近的镜像（非必须，只是为了加快下载速度），然后安装 bookdown，在控制台中运行：

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{install.packages}\NormalTok{(}\StringTok{"bookdown"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

安装完成后，重启 RStudio。

\hypertarget{ux5b89ux88c5-tex}{%
\subsection{安装 tex}\label{ux5b89ux88c5-tex}}

此步骤非必须，仅在生成 PDF 时需要。建议安装 \href{https://tug.org/texlive/}{tex live} 官方版本，而非其他简化版。

\hypertarget{ux4e0bux8f7dux9002ux5408ux4e2dux6587ux7684ux6a21ux677f}{%
\subsection{下载适合中文的模板}\label{ux4e0bux8f7dux9002ux5408ux4e2dux6587ux7684ux6a21ux677f}}

Bookdown 的作者\href{https://yihui.org/}{谢益辉博士}，提供了适合非常\href{https://github.com/yihui/bookdown-chinese}{不错的中文排版模板}。使用 RStudio 打开后，即可在其基础上专心于进行内容的创作。

北京大学的\href{http://www.math.pku.edu.cn/teachers/lidf/}{李东风教授}，也提供了一个\href{http://www.math.pku.edu.cn/teachers/lidf/docs/Rbook/html/_Rbook/index.html}{非常实用的中文模板}。

\hypertarget{basic}{%
\chapter{Bookdown 的基本用法}\label{basic}}

从本质上讲，bookdown 是基于 Pandoc、markdown、R、Rmarkdown、gitbook、tex、git 等等一系列开源项目上的综合性工具，这套工具大大降低了用户自己整合上述多个工具的成本，以更加高效地方式完成内容创作、发布和维护。

\hypertarget{ux4f7fux7528bookdownux521bux4f5cux7684ux6d41ux7a0b}{%
\section{使用bookdown创作的流程}\label{ux4f7fux7528bookdownux521bux4f5cux7684ux6d41ux7a0b}}

\hypertarget{ux521dux59cbux5316}{%
\subsection{初始化}\label{ux521dux59cbux5316}}

使用下载的模板或者bookdown自带的模板，创建bookdown项目。建议使用前者，因为更加适合中文内容的排版。

当然，当用户熟悉了bookdown之后，还可以在这些模板的基础上进行必要的配置，使之更加符合用户的需求。

\hypertarget{ux7f16ux8f91ux5185ux5bb9}{%
\subsection{编辑内容}\label{ux7f16ux8f91ux5185ux5bb9}}

在合适的编辑器中（建议先使用RStudio，后期熟悉后，可使用VS Code之类的功能更为复杂的通用性编辑器），按照markdown以及Rmarkdown的语法规则，进行内容的创作和编辑。

\hypertarget{ux9884ux89c8ux5185ux5bb9}{%
\subsection{预览内容}\label{ux9884ux89c8ux5185ux5bb9}}

选择 RStudio 中的``\texttt{Build\ Book}''功能，生成合适格式。还可以在控制台中键入如下命令，开启实时预览：

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bookdown}\OperatorTok{::}\KeywordTok{serve_book}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{ux53d1ux5e03}{%
\subsection{发布}\label{ux53d1ux5e03}}

利用 GitHub 或 Gitee 的 page 服务，可将生成的静态页面发布到网络。

\hypertarget{bookdown-ux5bf9ux6587ux6863ux7684ux7ec4ux7ec7}{%
\section{bookdown 对文档的组织}\label{bookdown-ux5bf9ux6587ux6863ux7684ux7ec4ux7ec7}}

和一篇文章相比，一本书包含多个章节。在bookdown中，一个章节对应一个后缀名为\texttt{.Rmd}的 R Markdown 文件，每个 R Markdown 文件（除了首页）都必须以一级标题开头。例如：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{# bookdown 对书本文档的组织}
\end{Highlighting}
\end{Shaded}

默认情况下，bookdown 按照文件名的顺序，从前到后合并在一起，并渲染成gitbook格式或者pdf、epub或者word文件。

如果存在\texttt{index.Rmd}文件，则该文件会被渲染成\texttt{index.html}。以下划线开头的文件，会被bookdown忽略。

bookdown 还提供了自定义章节顺序的机制。在配置文件\texttt{\_bookdown.yml}中，通过\texttt{rmd\_files}字段实现，例如：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rmd_files}\KeywordTok{:}\AttributeTok{ }\KeywordTok{[}\StringTok{"index.Rmd"}\KeywordTok{,}\AttributeTok{ }\StringTok{"abstract.Rmd"}\KeywordTok{,}\AttributeTok{ }\StringTok{"intro.Rmd"}\KeywordTok{]}
\end{Highlighting}
\end{Shaded}

还可以分别为不同格式指定包含的内容：

\begin{verbatim}
rmd_files:
  html: ["index.Rmd", "abstract.Rmd", "intro.Rmd"]
  latex: ["abstract.Rmd", "intro.Rmd"]
\end{verbatim}

必须要指出的是，每个章节的一级标题后，需要在后面加上标签，如：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{# Bookdown 的基本用法 \{#basic\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{bookdown-ux8bedux6cd5}{%
\section{bookdown 语法}\label{bookdown-ux8bedux6cd5}}

首先，bookdown是基于markdown和pandoc的工具，因此，\href{https://daringfireball.net/projects/markdown/syntax}{Markdown 的原生语法}肯定是可以使用的。在此不再赘述。

其次，\href{https://pandoc.org/MANUAL.html\#pandocs-markdown}{Pandoc 在markdown语法的基础上，提供了一些增强}，bookdown也是支持的。

最后，bookdown 是在 \href{https://rmarkdown.rstudio.com/index.html}{R bookdown 包}的基础上进行扩展，故而也支持 R Markdown 语法。如：

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{dim}\NormalTok{(iris)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 150   5
\end{verbatim}

再如，下面的代码将列出R Markdown支持的所有语言：

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{names}\NormalTok{(knitr}\OperatorTok{::}\NormalTok{knit_engines}\OperatorTok{$}\KeywordTok{get}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "awk"         "bash"        "coffee"      "gawk"        "groovy"     
##  [6] "haskell"     "lein"        "mysql"       "node"        "octave"     
## [11] "perl"        "psql"        "Rscript"     "ruby"        "sas"        
## [16] "scala"       "sed"         "sh"          "stata"       "zsh"        
## [21] "highlight"   "Rcpp"        "tikz"        "dot"         "c"          
## [26] "fortran"     "fortran95"   "asy"         "cat"         "asis"       
## [31] "stan"        "block"       "block2"      "js"          "css"        
## [36] "sql"         "go"          "python"      "julia"       "sass"       
## [41] "scss"        "theorem"     "lemma"       "corollary"   "proposition"
## [46] "conjecture"  "definition"  "example"     "exercise"    "proof"      
## [51] "remark"      "solution"
\end{verbatim}

\hypertarget{howtodo}{%
\chapter{常用功能的实现}\label{howtodo}}

\hypertarget{ux5982ux4f55ux63d2ux5165ux53c2ux8003ux6587ux732e}{%
\section{如何插入参考文献}\label{ux5982ux4f55ux63d2ux5165ux53c2ux8003ux6587ux732e}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  插入参考文献时，需要创建.bib格式的参考文献数据库。
\item
  在合适的地方插入引用\citep{xie2015}，语法如下：

\begin{verbatim}
引用[@xie2015]
\end{verbatim}
\item
  单独创建一个显示全部参考文献的.Rmd文件，内容如下：

\begin{verbatim}
\end{verbatim}
\end{enumerate}

按照上述步骤，将在章节末尾和全书末尾生成参考文献。

\hypertarget{ux5982ux4f55ux5c06ux53c2ux8003ux6587ux732eux683cux5f0fux8c03ux6574ux4e3aux56fdux6807ux683cux5f0f}{%
\section{如何将参考文献格式调整为国标格式}\label{ux5982ux4f55ux5c06ux53c2ux8003ux6587ux732eux683cux5f0fux8c03ux6574ux4e3aux56fdux6807ux683cux5f0f}}

在首页文件\texttt{index.Rmd}中，用户可以通过\texttt{biblio-style}指定参考文献的格式，例如：

\begin{Shaded}
\begin{Highlighting}[]
\PreprocessorTok{---}
\FunctionTok{bibliography}\KeywordTok{:}\AttributeTok{ }\KeywordTok{[}\StringTok{"one.bib"}\KeywordTok{,}\AttributeTok{ }\StringTok{"another.bib"}\KeywordTok{,}\AttributeTok{ }\StringTok{"yet-another.bib"}\KeywordTok{]}
\FunctionTok{biblio-style}\KeywordTok{:}\AttributeTok{ }\StringTok{"GBT7714-2005"}
\FunctionTok{link-citations}\KeywordTok{:}\AttributeTok{ }\CharTok{true}
\PreprocessorTok{---}
\end{Highlighting}
\end{Shaded}

与此同时，还需要将上述文件复制到项目目录中，不过上述设定，仅对PDF和word输出时起作用，对于gitbook格式，则没有效果。

\hypertarget{ux5982ux4f55ux8bbeux7f6eux7d22ux5f15}{%
\section{如何设置索引}\label{ux5982ux4f55ux8bbeux7f6eux7d22ux5f15}}

在一些书的后面，我们可以看到一些人名、术语的索引\index{索引}（index），在bookdown中，可以通过\texttt{\textbackslash{}index\{\}}实现。

但目前而言，只支持PDF格式的输出。需要在latex的导言区文件\texttt{preamble.tex}中，加入：

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{\textbackslash{}usepackage}\NormalTok{\{}\ExtensionTok{makeidx}\NormalTok{\}}
\FunctionTok{\textbackslash{}makeindex}
\end{Highlighting}
\end{Shaded}

然后在配置文件\texttt{after\_body.tex}中，加入：

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{\textbackslash{}printindex}
\end{Highlighting}
\end{Shaded}

\bibliography{book.bib,packages.bib}

\backmatter
\printindex

\end{document}
